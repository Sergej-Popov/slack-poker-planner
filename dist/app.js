!function(e){var t={};function n(s){if(t[s])return t[s].exports;var r=t[s]={i:s,l:!1,exports:{}};return e[s].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=e,n.c=t,n.d=function(e,t,s){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(n.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(s,r,function(t){return e[t]}.bind(null,r));return s},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=24)}([function(e,t){e.exports=require("@opentelemetry/api")},function(e,t){e.exports=require("shortid")},function(e,t){e.exports=require("countly-sdk-nodejs")},function(e,t){e.exports=require("@slack/web-api")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("util")},function(e,t){e.exports=require("@opentelemetry/tracing")},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("lodash/map")},function(e,t){e.exports=require("@opentelemetry/exporter-jaeger")},function(e,t){e.exports=require("pino")},function(e,t){e.exports=require("sqlite3")},function(e,t){e.exports=require("sqlite")},function(e,t){e.exports=require("redis")},function(e,t){e.exports=require("express-handlebars")},function(e,t){e.exports=require("async_hooks")},function(e,t){e.exports=require("lodash/isString")},function(e,t){e.exports=require("lodash/uniqBy")},function(e,t){e.exports=require("lodash/chunk")},function(e,t){e.exports=require("lodash/groupBy")},function(e,t){e.exports=require("lodash/isEmpty")},function(e,t){e.exports=require("lodash/uniq")},function(e,t){e.exports=require("lodash/find")},function(e,t){e.exports=require("dotenv")},function(e,t,n){"use strict";n.r(t);var s=n(6),r=n(9),o=n(10);var i=n.n(o)()({formatters:{level:(e,t)=>({level:e}),bindings:e=>({})}}),a=n(11),c=n(12),l=function(e,t,n,s){return new(n||(n=Promise))((function(r,o){function i(e){try{c(s.next(e))}catch(e){o(e)}}function a(e){try{c(s.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}c((s=s.apply(e,t||[])).next())}))};let d;function u(){return d}var p=n(13),m=function(e,t,n,s){return new(n||(n=Promise))((function(r,o){function i(e){try{c(s.next(e))}catch(e){o(e)}}function a(e){try{c(s.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}c((s=s.apply(e,t||[])).next())}))};let f;function v(){return f}var _=n(2),h=n.n(_),y=n(4),g=n(7),I=n(14),S=n(3),b=n(15),P=n(0);const A=new b.AsyncLocalStorage;function N(e={}){return(t,n,s)=>{const r=s.value,o=e.name||n;return s.value=function(...e){const t=P.trace.getTracer("default"),n=A.getStore(),s={};n&&(s.parent=n.span);const i=t.startSpan(o,s);try{const t=A.run({span:i},()=>r.apply(this,e));return"object"==typeof t&&t.then&&t.catch?t.then(e=>(i.end(),e)).catch(e=>{throw i.addEvent("error",{event:"error",message:e.message,stack:e.stack,"error.kind":e.name}),i.setStatus({code:P.CanonicalCode.UNKNOWN,message:e.message}),i.end(),e}):(i.end(),t)}catch(e){throw i.addEvent("error",{event:"error",message:e.message,stack:e.stack,"error.kind":e.name}),i.setStatus({code:P.CanonicalCode.UNKNOWN,message:e.message}),i.end(),e}},s}}function x(){const e=A.getStore();return null==e?void 0:e.span}var T,E=function(e,t,n,s){var r,o=arguments.length,i=o<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,n):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,n,s);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(o<3?r(i):o>3?r(t,n,i):r(t,n))||i);return o>3&&i&&Object.defineProperty(t,n,i),i},C=function(e,t,n,s){return new(n||(n=Promise))((function(r,o){function i(e){try{c(s.next(e))}catch(e){o(e)}}function a(e){try{c(s.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}c((s=s.apply(e,t||[])).next())}))};!function(e){e.PARTICIPANTS="participants",e.POINTS="points",e.PROTECTED="proctected"}(T||(T={}));let O=(()=>{class e{static findById(e){return C(this,void 0,void 0,(function*(){const t=x();null==t||t.setAttribute("id",e);return u().get("SELECT * FROM team WHERE id = ?",e)}))}static create({id:e,name:t,access_token:n,scope:s,user_id:r}){return C(this,void 0,void 0,(function*(){const o=x();null==o||o.setAttributes({id:e,name:t,scope:s,user_id:r});const i=u();yield i.run("INSERT INTO\n          team (id, name, access_token, scope, user_id)\n        VALUES\n          ($id, $name, $access_token, $scope, $user_id)",{$id:e,$name:t,$access_token:n,$scope:s,$user_id:r})}))}static update({id:e,name:t,access_token:n,scope:s,user_id:r}){return C(this,void 0,void 0,(function*(){const o=x();null==o||o.setAttributes({id:e,name:t,scope:s,user_id:r});const i=u();yield i.run("UPDATE\n        team\n      SET\n        name = $name,\n        access_token = $access_token,\n        scope = $scope,\n        user_id = $user_id\n      WHERE\n        id = $id",{$id:e,$name:t,$access_token:n,$scope:s,$user_id:r})}))}static upsert({id:t,name:n,access_token:s,scope:r,user_id:o}){return C(this,void 0,void 0,(function*(){const i=x();null==i||i.setAttributes({id:t,name:n,scope:r,user_id:o});return(yield e.findById(t))?yield e.update({id:t,name:n,access_token:s,scope:r,user_id:o}):yield e.create({id:t,name:n,access_token:s,scope:r,user_id:o}),e.findById(t)}))}static fetchSettings(e,t){return C(this,void 0,void 0,(function*(){const n=x();null==n||n.setAttributes({teamId:e,channelId:t});const s=u(),r=yield s.all("SELECT\n        setting_key,\n        setting_value\n      FROM\n        channel_settings\n      WHERE\n        team_id = $teamId AND\n        channel_id = $channelId;",{$teamId:e,$channelId:t}),o={};return r.forEach(e=>{o[e.setting_key]=e.setting_value}),o}))}static upsertSettings(t,n,s){return C(this,void 0,void 0,(function*(){const r=Object.keys(s).map(r=>e.upsertSetting(t,n,r,s[r]));yield Promise.all(r)}))}static upsertSetting(e,t,n,s){return C(this,void 0,void 0,(function*(){const r=x();null==r||r.setAttributes({teamId:e,channelId:t,key:n,value:s});const o=u();yield o.run("INSERT INTO\n        channel_settings (team_id, channel_id, setting_key, setting_value)\n      VALUES (\n        $teamId,\n        $channelId,\n        $settingKey,\n        $settingValue\n      )\n      ON CONFLICT(team_id, channel_id, setting_key)\n      DO UPDATE SET setting_value = $settingValue;",{$teamId:e,$channelId:t,$settingKey:n,$settingValue:s})}))}}return E([N({name:"team.findById"})],e,"findById",null),E([N({name:"team.create"})],e,"create",null),E([N({name:"team.update"})],e,"update",null),E([N({name:"team.upsert"})],e,"upsert",null),E([N()],e,"fetchSettings",null),E([N()],e,"upsertSettings",null),E([N()],e,"upsertSetting",null),e})();var w=n(1),k=function(e,t,n,s){return new(n||(n=Promise))((function(r,o){function i(e){try{c(s.next(e))}catch(e){o(e)}}function a(e){try{c(s.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}c((s=s.apply(e,t||[])).next())}))};function L(e){return k(this,void 0,void 0,(function*(){try{return[void 0,yield e]}catch(e){return[e,void 0]}}))}var j=function(e,t,n,s){return new(n||(n=Promise))((function(r,o){function i(e){try{c(s.next(e))}catch(e){o(e)}}function a(e){try{c(s.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}c((s=s.apply(e,t||[])).next())}))};class ${static handle(e,t){return j(this,void 0,void 0,(function*(){if(e.query.error)return i.error({msg:"Could not oauth",err:e.query.error}),t.status(500).send(e.query.error);if(e.query.code){const n=new S.WebClient,[s,r]=yield L(n.oauth.v2.access({client_id:process.env.SLACK_CLIENT_ID,client_secret:process.env.SLACK_CLIENT_SECRET,code:e.query.code}));if(s){const e=Object(w.generate)();return i.error({msg:"Could not oauth, slack api call failed",errorId:e,err:s}),t.status(500).send(`Internal server error, please try again (error code: ${e})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`)}const[o,a]=yield L(O.upsert({id:r.team.id,name:r.team.name,access_token:r.access_token,scope:r.scope,user_id:r.authed_user.id}));if(o){const e=Object(w.generate)();i.error({msg:"Could not oauth, sqlite upsert failed",errorId:e,err:o}),t.status(500).send(`Internal server error, please try again later (error code: ${e})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`)}return process.env.COUNTLY_APP_KEY&&h.a.add_event({key:"added_to_team",count:1,segmentation:{}}),i.info({msg:"Added to team",team:a}),t.render("oauth-success",{layout:!1,data:{SLACK_APP_ID:process.env.SLACK_APP_ID,TEAM_NAME:a.name}})}const n=Object(w.generate)();return i.error({msg:"Could not oauth, unknown error",errorId:n,query:e.query}),t.status(500).send(`Unknown error (error code: ${n})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`)}))}}var R=n(16),U=n.n(R);function K(e,t){const n=[];let s;if(t.global)for(;s=t.exec(e);)n.push(s[1]);else(s=t.exec(e))&&n.push(s[1]);return n}var M=n(5),D=function(e,t,n,s){var r,o=arguments.length,i=o<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,n):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,n,s);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(o<3?r(i):o>3?r(t,n,i):r(t,n))||i);return o>3&&i&&Object.defineProperty(t,n,i),i},Y=function(e,t,n,s){return new(n||(n=Promise))((function(r,o){function i(e){try{c(s.next(e))}catch(e){o(e)}}function a(e){try{c(s.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}c((s=s.apply(e,t||[])).next())}))};const q={};let V=(()=>{class e{static findById(e){return Y(this,void 0,void 0,(function*(){if(!process.env.USE_REDIS)return q[e];const t=x();null==t||t.setAttribute("id",e);const n=v(),s=Object(M.promisify)(n.get.bind(n)),r=yield s(B(e));return r?JSON.parse(r):void 0}))}static upsert(e){return Y(this,void 0,void 0,(function*(){if(!process.env.USE_REDIS)return void(q[e.id]=e);const t=x();null==t||t.setAttribute("id",e.id);const n=v(),s=Object(M.promisify)(n.set.bind(n));yield s(B(e.id),JSON.stringify(e),"EX",Number(process.env.REDIS_SESSION_TTL))}))}static delete(e){return Y(this,void 0,void 0,(function*(){if(!process.env.USE_REDIS)return void delete q[e];const t=x();null==t||t.setAttribute("id",e);const n=v(),s=Object(M.promisify)(n.del.bind(n));yield s(B(e))}))}}return D([N({name:"session.findById"})],e,"findById",null),D([N({name:"session.upsert"})],e,"upsert",null),D([N({name:"session.delete"})],e,"delete",null),e})();function B(e){return`${process.env.REDIS_NAMESPACE}:session:${e}`}var J=n(17),W=n.n(J),G=n(18),H=n.n(G),F=n(8),Q=n.n(F),z=n(19),X=n.n(z),Z=function(e,t,n,s){var r,o=arguments.length,i=o<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,n):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,n,s);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(o<3?r(i):o>3?r(t,n,i):r(t,n))||i);return o>3&&i&&Object.defineProperty(t,n,i),i},ee=function(e,t,n,s){return new(n||(n=Promise))((function(r,o){function i(e){try{c(s.next(e))}catch(e){o(e)}}function a(e){try{c(s.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}c((s=s.apply(e,t||[])).next())}))};const te=["0","1/2","1","2","3","5","8","13","20","40","100","∞","?"];var ne;!function(e){e.NO_PARTICIPANTS="no_participants",e.TITLE_REQUIRED="title_required",e.INVALID_POINTS="invalid_points",e.SESSION_NOT_ACTIVE="session_not_active",e.ONLY_PARTICIPANTS_CAN_VOTE="only_participants_can_vote"}(ne||(ne={}));let se=(()=>{class e{static postMessage(e,t){return ee(this,void 0,void 0,(function*(){const n=new S.WebClient(t.access_token),s=Q()(e.participants.sort(),e=>`<@${e}>: awaiting`).join("\n");return n.chat.postMessage({channel:e.channelId,text:`Title: *${e.title}*\n\nVotes:\n${s}`,attachments:re(e)})}))}static openModal({triggerId:e,team:t,channelId:n,title:s,participants:r,points:o,isProtected:i}){return ee(this,void 0,void 0,(function*(){const a=new S.WebClient(t.access_token),c={text:{type:"plain_text",text:"Protected (prevent others to cancel or reveal this session)",emoji:!0},value:"protected"};yield a.views.open({trigger_id:e,view:{callback_id:"newSessionModal:submit",private_metadata:JSON.stringify({channelId:n}),type:"modal",title:{type:"plain_text",text:"Poker Planner",emoji:!0},submit:{type:"plain_text",text:"Start New Session",emoji:!0},close:{type:"plain_text",text:"Cancel",emoji:!0},blocks:[{type:"input",block_id:"title",element:{type:"plain_text_input",placeholder:{type:"plain_text",text:"Write a topic for this voting session",emoji:!0},initial_value:s||""},label:{type:"plain_text",text:"Title",emoji:!0}},{type:"input",block_id:"participants",element:{type:"multi_users_select",placeholder:{type:"plain_text",text:"Add users",emoji:!0},initial_users:r},label:{type:"plain_text",text:"Participants",emoji:!0}},{type:"input",block_id:"points",element:{type:"plain_text_input",placeholder:{type:"plain_text",text:"Change poker points",emoji:!0},initial_value:o.join(" ")||te.join(" ")},hint:{type:"plain_text",text:"Enter points seperated by space",emoji:!0},label:{type:"plain_text",text:"Points",emoji:!0}},{type:"input",block_id:"other",optional:!0,element:{type:"checkboxes",options:[c],initial_options:i?[c]:void 0},label:{type:"plain_text",text:"Other",emoji:!0}},{type:"section",text:{type:"mrkdwn",text:"> :bulb: These options will be *remembered* the next time you create a session *on this channel*."}}]}})}))}static revealAndUpdateMessage(t,n,s){return ee(this,void 0,void 0,(function*(){t.state="revealed",yield e.updateMessage(t,n,s),yield V.delete(t.id)}))}static cancelAndUpdateMessage(t,n,s){return ee(this,void 0,void 0,(function*(){t.state="cancelled",yield e.updateMessage(t,n,s),yield V.delete(t.id)}))}static vote(t,n,s,r){return ee(this,void 0,void 0,(function*(){if("active"!=t.state)throw new Error(ne.SESSION_NOT_ACTIVE);if(-1==t.participants.indexOf(s))throw new Error(ne.ONLY_PARTICIPANTS_CAN_VOTE);if(t.votes[s]=r,t.state=Object.keys(t.votes).length==t.participants.length?"revealed":"active","revealed"==t.state)return yield e.updateMessage(t,n),yield V.delete(t.id),void i.info({msg:"Auto revealing votes",sessionId:t.id,team:{id:n.id,name:n.name}});yield V.upsert(t);try{yield e.updateMessage(t,n)}catch(e){i.warn({msg:"Could not refreshed session message after a vote",err:e,session:t,userId:s,point:r})}}))}static updateMessage(e,t,n){return ee(this,void 0,void 0,(function*(){const s=new S.WebClient(t.access_token);if("revealed"==e.state){const t=X()(e.participants,t=>e.votes[t]||"not-voted"),r=Object.keys(t).sort().map(e=>{const n=t[e],s=1==n.length?"1 person":n.length+" people",r=n.sort().map(e=>`<@${e}>`).join(", ");return"not-voted"==e?`${s} *did not vote* (${r})`:`${s} voted *${e}* (${r})`}).join("\n");yield s.chat.update({ts:e.rawPostMessageResponse.ts,channel:e.rawPostMessageResponse.channel,text:n?`Title: *${e.title}* (revealed by <@${n}>)\n\nResult:\n${r}`:`Title: *${e.title}*\n\nResult:\n${r}`,attachments:[]})}else if("cancelled"==e.state)yield s.chat.update({ts:e.rawPostMessageResponse.ts,channel:e.rawPostMessageResponse.channel,text:n?`Title: *${e.title}* (cancelled by <@${n}>)`:`Title: *${e.title}* (cancelled)`,attachments:[]});else{const t=Q()(e.participants.sort(),t=>e.votes.hasOwnProperty(t)?`<@${t}>: :white_check_mark:`:`<@${t}>: awaiting`).join("\n");yield s.chat.update({ts:e.rawPostMessageResponse.ts,channel:e.rawPostMessageResponse.channel,text:`Title: *${e.title}*\n\nVotes:\n${t}`,attachments:re(e)})}}))}static exractMentions(e){const t=[];return K(e,/<@(.*?)>/g).forEach(e=>{t.push({type:"user",id:e.split("|")[0]})}),K(e,/<!(.*?)>/g).forEach(e=>{if(["everyone","channel","here"].indexOf(e)>-1)t.push({type:"special",id:e});else if(e.includes("subteam")){const[n,s]=e.replace("subteam^","").split("|");t.push({type:"user-group",id:n})}}),W()(t,e=>`${e.type}-${e.id}`)}static stripMentions(e){return e.replace(/<@(.*?)>/g,"").replace(/<!(.*?)>/g,"").replace(/\s\s+/g," ").trim()}}return Z([N()],e,"postMessage",null),Z([N()],e,"openModal",null),Z([N()],e,"revealAndUpdateMessage",null),Z([N()],e,"cancelAndUpdateMessage",null),Z([N()],e,"vote",null),Z([N()],e,"updateMessage",null),e})();function re(e){return[...H()(e.points,5).map(t=>({text:"",fallback:"You are unable to vote",callback_id:"vote:"+e.id,color:"#3AA3E3",attachment_type:"default",actions:t.map(e=>({name:"point",text:e,type:"button",value:e}))})),{text:"Actions",fallback:"You are unable to send action",callback_id:"action:"+e.id,color:"#3AA3E3",attachment_type:"default",actions:[{name:"action",text:"Reveal",type:"button",value:"reveal",style:"danger"},{name:"action",text:"Cancel",type:"button",value:"cancel",style:"danger"}]}]}var oe=function(e,t,n,s){var r,o=arguments.length,i=o<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,n):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,n,s);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(o<3?r(i):o>3?r(t,n,i):r(t,n))||i);return o>3&&i&&Object.defineProperty(t,n,i),i},ie=function(e,t,n,s){return new(n||(n=Promise))((function(r,o){function i(e){try{c(s.next(e))}catch(e){o(e)}}function a(e){try{c(s.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}c((s=s.apply(e,t||[])).next())}))};let ae=(()=>{class e{static handle(t,n){return ie(this,void 0,void 0,(function*(){const s=t.body;if(s.token!=process.env.SLACK_VERIFICATION_TOKEN)return i.error({msg:"Could not created session, slack verification token is invalid",cmd:s}),n.json({text:"Invalid slack verification token, please get in touch with the maintainer",response_type:"ephemeral",replace_original:!1});if(!U()(s.text)){const e=Object(w.generate)();return i.error({msg:"Could not created session, command.text not string",errorId:e,cmd:s}),n.json({text:`Unexpected command usage (error code: ${e})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`,response_type:"ephemeral",replace_original:!1})}switch(s.text.trim().split(" ")[0]){case"help":return e.help(n);case"config":return yield e.configure(s,n);default:return yield e.openNewSessionModal(s,n)}}))}static openNewSessionModal(e,t){return ie(this,void 0,void 0,(function*(){const n=x();if(null==n||n.setAttributes({teamId:e.team_id,teamDomain:e.team_domain,channelId:e.channel_id,channelName:e.channel_name,userId:e.user_id,userName:e.user_name,text:e.text}),"directmessage"==e.channel_name)return t.json({text:"Poker planning cannot be started in direct messages",response_type:"ephemeral",replace_original:!1});const[s,r]=yield L(O.findById(e.team_id));if(s){const r=Object(w.generate)();return i.error({msg:"Could not created session, could not get the team from db",errorId:r,err:s,cmd:e}),null==n||n.setAttribute("error.id",r),null==n||n.setStatus({code:P.CanonicalCode.INTERNAL,message:s.message}),t.json({text:`Internal server error, please try again later (error code: ${r})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`,response_type:"ephemeral",replace_original:!1})}if(!r)return i.info({msg:"Could not created session, team could not be found",cmd:e}),null==n||n.setStatus({code:P.CanonicalCode.NOT_FOUND,message:"Team not found"}),t.json({text:`Your Slack team (${e.team_domain}) could not be found, please reinstall Poker Planner on <${process.env.APP_INSTALL_LINK}>`,response_type:"ephemeral",replace_original:!1});if("identify,commands,channels:read,groups:read,users:read,chat:write:bot"==r.scope)return i.info({msg:"Migration message",team:{id:r.id,name:r.name},user:{id:e.user_id,name:e.user_name}}),null==n||n.addEvent("show_migration_message"),t.json({text:`Poker Planner has migrated to <https://slackhq.com/introducing-a-dramatically-upgraded-slack-app-toolkit|Slack's new app toolkit> which adds granular permissions for better security. We now depend on bot permissions instead of user permissions. So that you can explicitly manage which channels/conversations Poker Planner can access. However, this requires a couple of changes:\n\n• In order to obtain new bot permissions and drop user ones, *you need to reinstall Poker Planner* to your workspace on <${process.env.APP_INSTALL_LINK}>\n• Before using \`/pp\` command, *Poker Planner app must be added to that channel/conversation*. You can simply add or invite it by just mentioning the app like \`@poker_planner\`. You can also do that from channel/converstion details menu.`,response_type:"ephemeral",replace_original:!1});try{const[s,o]=yield L(O.fetchSettings(r.id,e.channel_id));s&&(null==n||n.addEvent("settings_fetch_error",{error:s.message}));const i={[T.PARTICIPANTS]:[],[T.POINTS]:te,[T.PROTECTED]:!1};(null==o?void 0:o[T.PARTICIPANTS])&&(i[T.PARTICIPANTS]=o[T.PARTICIPANTS].split(" ")),r.custom_points&&(i[T.POINTS]=r.custom_points.split(" ")),(null==o?void 0:o[T.POINTS])&&(i[T.POINTS]=o[T.POINTS].split(" ")),(null==o?void 0:o[T.PROTECTED])&&(i[T.PROTECTED]=JSON.parse(o[T.PROTECTED])),yield se.openModal({triggerId:e.trigger_id,team:r,channelId:e.channel_id,title:se.stripMentions(e.text).trim(),participants:i[T.PARTICIPANTS],points:i[T.POINTS],isProtected:i[T.PROTECTED]}),t.send(),process.env.COUNTLY_APP_KEY&&h.a.add_event({key:"new_session_modal_opened",count:1,segmentation:{}})}catch(s){const r=Object(w.generate)();return i.error({msg:"Could not open modal",errorId:r,err:s,cmd:e}),null==n||n.setAttribute("error.id",r),null==n||n.setStatus({code:P.CanonicalCode.INTERNAL,message:s.message}),t.json({text:`Could not open modal (error code: ${r})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`,response_type:"ephemeral",replace_original:!1})}}))}static configure(e,t){return ie(this,void 0,void 0,(function*(){return t.json({text:"This command is depracated. The session settings (points, participants, ...) are now persisted automatically for each channel/conversation.",response_type:"ephemeral",replace_original:!1})}))}static help(e){return e.json({text:"",response_type:"ephemeral",replace_original:!1,attachments:[{color:"#3AA3E3",text:"`/pp`\nOpens a dialog to start a new poker planning session."},{color:"#3AA3E3",text:"`/pp some topic text`\nOpens the same dialog, however title input is automatically filled with the value you provided."}]})}}return oe([N()],e,"openNewSessionModal",null),e})();var ce=n(20),le=n.n(ce),de=n(21),ue=n.n(de),pe=n(22),me=n.n(pe),fe=function(e,t,n,s){var r,o=arguments.length,i=o<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,n):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,n,s);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(i=(o<3?r(i):o>3?r(t,n,i):r(t,n))||i);return o>3&&i&&Object.defineProperty(t,n,i),i},ve=function(e,t,n,s){return new(n||(n=Promise))((function(r,o){function i(e){try{c(s.next(e))}catch(e){o(e)}}function a(e){try{c(s.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}c((s=s.apply(e,t||[])).next())}))};let _e=(()=>{class e{static handle(t,n){return ve(this,void 0,void 0,(function*(){let s;try{s=JSON.parse(t.body.payload)}catch(e){const s=Object(w.generate)();return i.error({msg:"Could not parse action payload",errorId:s,body:t.body}),n.json({text:`Unexpected slack action payload (error code: ${s})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`,response_type:"ephemeral",replace_original:!1})}if(s.token!=process.env.SLACK_VERIFICATION_TOKEN)return i.error({msg:"Could not process action, invalid verification token",payload:s}),n.json({text:"Invalid slack verification token, please get in touch with the maintainer",response_type:"ephemeral",replace_original:!1});switch(s.type){case"interactive_message":return void(yield e.interactiveMessage({payload:s,res:n}));case"view_submission":return void(yield e.viewSubmission({payload:s,res:n}));default:{const e=Object(w.generate)();return i.error({msg:"Unexpected interactive-message action callbackId",errorId:e,payload:s}),n.json({text:`Unexpected payload type (error code: ${e})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`,response_type:"ephemeral",replace_original:!1})}}}))}static interactiveMessage({payload:t,res:n}){return ve(this,void 0,void 0,(function*(){const s=x();null==s||s.setAttributes({callbackId:t.callback_id,teamId:t.team.id,teamDomain:t.team.domain,userId:t.user.id,userName:t.user.name,channelId:t.channel.id,channelName:t.channel.name});const r=t.callback_id.split(":");if(2!=r.length){const e=Object(w.generate)();return i.error({msg:"Unexpected interactive message callback id",errorId:e,payload:t}),null==s||s.setAttribute("error.id",e),null==s||s.setStatus({code:P.CanonicalCode.INVALID_ARGUMENT,message:"Unexpected callback_id"}),n.json({text:`Unexpected interactive message callback id (error code: ${e})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`,response_type:"ephemeral",replace_original:!1})}const[o,a]=r;null==s||s.setAttributes({action:o,sessionId:a});const[c,l]=yield L(V.findById(a));if(c){const e=Object(w.generate)();return i.error({msg:"Could not get session",errorId:e,err:c,payload:t}),null==s||s.setAttribute("error.id",e),null==s||s.setStatus({code:P.CanonicalCode.INTERNAL,message:c.message}),n.json({text:`Internal server error, please try again later (error code: ${e})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`,response_type:"ephemeral",replace_original:!1})}if(!l)return null==s||s.setStatus({code:P.CanonicalCode.NOT_FOUND,message:"Session not found"}),n.json({text:"Ooops, could not find the session, it may be expired or cancelled",response_type:"ephemeral",replace_original:!1});const[d,u]=yield L(O.findById(t.team.id));if(d){const e=Object(w.generate)();return i.error({msg:"Could not get team",errorId:e,err:d,payload:t}),null==s||s.setAttribute("error.id",e),null==s||s.setStatus({code:P.CanonicalCode.INTERNAL,message:d.message}),n.json({text:`Internal server error, please try again later (error code: ${e})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`,response_type:"ephemeral",replace_original:!1})}if(!u)return null==s||s.setStatus({code:P.CanonicalCode.NOT_FOUND,message:"Team not found"}),n.json({text:`Your Slack team (${t.team.domain}) could not be found, please reinstall Poker Planner on <${process.env.APP_INSTALL_LINK}>`,response_type:"ephemeral",replace_original:!1});switch(o){case"action":{const r=t.actions[0].value;if(null==s||s.setAttributes({sessionAction:r}),"reveal"==r)yield e.revealSession({payload:t,team:u,session:l,res:n});else if("cancel"==r)yield e.cancelSession({payload:t,team:u,session:l,res:n});else{const e=Object(w.generate)();i.error({msg:"Unexpected action button clicked",errorId:e,sessionAction:r,payload:t}),null==s||s.setAttribute("error.id",e),null==s||s.setStatus({code:P.CanonicalCode.INVALID_ARGUMENT,message:"Unexpected session action"}),n.json({text:`Unexpected action button (error code: ${e})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`,response_type:"ephemeral",replace_original:!1})}return}case"vote":return void(yield e.vote({payload:t,team:u,session:l,res:n}));default:{const e=Object(w.generate)();return i.error({msg:"Unexpected action",errorId:e,action:o,payload:t}),null==s||s.setAttribute("error.id",e),null==s||s.setStatus({code:P.CanonicalCode.INVALID_ARGUMENT,message:"Unexpected action"}),n.json({text:`Unexpected action (error code: ${e})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`,response_type:"ephemeral",replace_original:!1})}}}))}static viewSubmission({payload:t,res:n}){return ve(this,void 0,void 0,(function*(){const s=x();null==s||s.setAttributes({teamId:t.team.id,teamDomain:t.team.domain,userId:t.user.id,userName:t.user.name});const[r,o]=yield L(O.findById(t.team.id));if(r){const e=Object(w.generate)();return i.error({msg:"Could not create session, could not get the team from db",errorId:e,err:r,payload:t}),null==s||s.setAttribute("error.id",e),null==s||s.setStatus({code:P.CanonicalCode.INTERNAL,message:r.message}),n.json({text:`Internal server error, please try again later (error code: ${e})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`,response_type:"ephemeral",replace_original:!1})}if(!o)return i.info({msg:"Could not create session, team could not be found",payload:t}),null==s||s.setStatus({code:P.CanonicalCode.NOT_FOUND,message:"Team not found"}),n.json({text:`Your Slack team (${t.team.domain}) could not be found, please reinstall Poker Planner on <${process.env.APP_INSTALL_LINK}>`,response_type:"ephemeral",replace_original:!1});const a=t.view.callback_id;switch(null==s||s.setAttributes({callbackId:a}),a){case"newSessionModal:submit":return e.createSession({payload:t,team:o,res:n});default:{const e=Object(w.generate)();return i.error({msg:"Unexpected view-submission action callbackId",errorId:e,callbackId:a,payload:t}),null==s||s.setAttribute("error.id",e),null==s||s.setStatus({code:P.CanonicalCode.INVALID_ARGUMENT,message:"Unexpected callback_id"}),n.json({text:`Unexpected view-submission callback id (error code: ${e})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`,response_type:"ephemeral",replace_original:!1})}}}))}static createSession({payload:e,team:t,res:n}){return ve(this,void 0,void 0,(function*(){const s=x();try{null==s||s.setAttributes({rawPrivateMetadata:e.view.private_metadata});const r=JSON.parse(e.view.private_metadata),o=e.view.state.values.title,a=o[Object.keys(o)[0]].value;if(null==s||s.setAttributes({title:a}),!a||0==a.trim().length)throw new Error(ne.TITLE_REQUIRED);const c=e.view.state.values.participants,l=c[Object.keys(c)[0]].selected_users;if(null==s||s.setAttributes({participants:l.join(" ")}),0==l.length)throw new Error(ne.NO_PARTICIPANTS);const d=e.view.state.values.points,u=d[Object.keys(d)[0]].value||"";let p=ue()(u.match(/\S+/g))||[];if(null==s||s.setAttributes({points:u}),1==p.length&&"reset"==p[0]&&(p=te),p.length<2||p.length>25)throw new Error(ne.INVALID_POINTS);const m=e.view.state.values.other,f=m?m[Object.keys(m)[0]].selected_options:[],v=!!me()(f,e=>"protected"==e.value);null==s||s.setAttributes({isProtected:""+v});const _={id:Object(w.generate)(),title:a,points:p,votes:{},state:"active",channelId:r.channelId,userId:e.user.id,participants:l,rawPostMessageResponse:void 0,protected:v};null==s||s.setAttributes({sessionId:_.id,channelId:r.channelId,userId:e.user.id,userName:e.user.name}),i.info({msg:"Creating a new session",team:{id:t.id,name:t.name},user:{id:e.user.id,name:e.user.name},channelId:r.channelId,sessionId:_.id});const y=yield se.postMessage(_,t);_.rawPostMessageResponse=y,yield V.upsert(_),n.send();const[g]=yield L(O.upsertSettings(t.id,_.channelId,{[T.PARTICIPANTS]:_.participants.join(" "),[T.POINTS]:_.points.join(" "),[T.PROTECTED]:JSON.stringify(_.protected)}));g&&(null==s||s.addEvent("upsert_settings_error",{message:g.message}),i.error({msg:"Could not upsert settings after creating new session",session:_,err:g})),process.env.COUNTLY_APP_KEY&&h.a.add_event({key:"topic_created",count:1,segmentation:{participants:_.participants.length}})}catch(t){const r=Object(w.generate)();let o=!0,a="error",c=`Internal server error, please try again later (error code: ${r})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`,l={};const d=t.data&&t.data.error;return d&&(null==s||s.setAttributes({slackErrorCode:d}),c=`Unexpected Slack API Error: "*${d}*" (error code: ${r})\n\nIf you think this is an issue, please report to <${process.env.ISSUES_LINK}>`),"not_in_channel"==d?(o=!1,c='Poker Planner app is not added to this channel. Please try again after adding it. You can simply add the app just by mentioning it, like "*@poker_planner*".'):"channel_not_found"==d?(o=!1,c='Oops, we couldn\'t find this channel. Are you sure that Poker Planner app is added to this channel/conversation? You can simply add the app by mentioning it, like "*@poker_planner*". However this may not work in Group DMs, you need to explicitly add it as a member from conversation details menu. Please try again after adding it.'):"token_revoked"==d?(a="info",c=`Poker Planner's access has been revoked for this workspace. In order to use it, you need to install the app again on <${process.env.APP_INSTALL_LINK}>`):"method_not_supported_for_channel_type"==d?(a="info",c="Poker Planner cannot be used in this type of conversations."):"missing_scope"==d?"mpim:read"==t.data.needed?(a="info",c=`Poker Planner now supports Group DMs! However it requires additional permissions that we didn't obtained previously. You need to visit <${process.env.APP_INSTALL_LINK}> and reinstall the app to enable this feature.`):"usergroups:read"==t.data.needed&&(a="info",c=`Poker Planner now supports @usergroup mentions! However it requires additional permissions that we didn't obtained previously. You need to visit <${process.env.APP_INSTALL_LINK}> and reinstall the app to enable this feature.`):t.message==ne.NO_PARTICIPANTS?(o=!1,c="You must add at least 1 person.",l={participants:c}):t.message==ne.TITLE_REQUIRED?(o=!1,c="Title is required",l={title:c}):t.message==ne.INVALID_POINTS&&(o=!1,c="You must provide at least 2 poker points, the maximum is 25.",l={points:c}),o&&i[a]({msg:"Could not create session",errorId:r,err:t,payload:e}),null==s||s.setAttributes({"error.id":r,userErrorMessage:c}),null==s||s.setStatus({code:P.CanonicalCode.UNKNOWN,message:t.message}),le()(l)?n.json({response_action:"push",view:{type:"modal",title:{type:"plain_text",text:"Poker Planner",emoji:!0},close:{type:"plain_text",text:"Close",emoji:!0},blocks:[{type:"section",text:{type:"mrkdwn",text:":x: "+c}}]}}):n.json({response_action:"errors",errors:l})}}))}static vote({payload:e,team:t,session:n,res:s}){return ve(this,void 0,void 0,(function*(){const r=x(),o=e.actions[0].value;null==r||r.setAttributes({point:o}),i.info({msg:"Voting",point:o,sessionId:n.id,team:{id:t.id,name:t.name},user:{id:e.user.id,name:e.user.name}});const[a]=yield L(se.vote(n,t,e.user.id,o));if(a)switch(a.message){case ne.SESSION_NOT_ACTIVE:return s.json({text:"You cannot vote revealed or cancelled session",response_type:"ephemeral",replace_original:!1});case ne.ONLY_PARTICIPANTS_CAN_VOTE:return s.json({text:"You are not a participant of that session",response_type:"ephemeral",replace_original:!1});default:{const t=Object(w.generate)();return i.error({msg:"Could not vote",errorId:t,err:a,payload:e}),null==r||r.setAttributes({"error.id":t}),null==r||r.setStatus({code:P.CanonicalCode.INVALID_ARGUMENT,message:"Unexpected vote error"}),s.json({text:`Internal server error, please try again later (error code: ${t})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`,response_type:"ephemeral",replace_original:!1})}}return process.env.COUNTLY_APP_KEY&&h.a.add_event({key:"topic_voted",count:1,segmentation:{points:e.actions[0].value}}),s.send()}))}static revealSession({payload:e,team:t,session:n,res:s}){return ve(this,void 0,void 0,(function*(){const r=x();if(null==r||r.setAttributes({sessionProtected:n.protected,sessionCreatorId:n.userId}),n.protected&&n.userId!=e.user.id)return s.json({text:"This session is protected, only the creator can reveal it.",response_type:"ephemeral",replace_original:!1});i.info({msg:"Revealing votes",sessionId:n.id,team:{id:t.id,name:t.name},user:{id:e.user.id,name:e.user.name}});const[o]=yield L(se.revealAndUpdateMessage(n,t,e.user.id));if(o){const t=Object(w.generate)();return i.error({msg:"Could not reveal session",errorId:t,err:o,payload:e}),null==r||r.setAttributes({"error.id":t}),null==r||r.setStatus({code:P.CanonicalCode.INTERNAL,message:"Unexpected error while reveal session & update message"}),s.json({text:`Internal server error, please try again later (error code: ${t})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`,response_type:"ephemeral",replace_original:!1})}return process.env.COUNTLY_APP_KEY&&h.a.add_event({key:"topic_revealed",count:1,segmentation:{}}),s.send()}))}static cancelSession({payload:e,team:t,session:n,res:s}){return ve(this,void 0,void 0,(function*(){const r=x();if(null==r||r.setAttributes({sessionProtected:n.protected,sessionCreatorId:n.userId}),n.protected&&n.userId!=e.user.id)return s.json({text:"This session is protected, only the creator can cancel it.",response_type:"ephemeral",replace_original:!1});i.info({msg:"Cancelling session",sessionId:n.id,team:{id:t.id,name:t.name},user:{id:e.user.id,name:e.user.name}});const[o]=yield L(se.cancelAndUpdateMessage(n,t,e.user.id));if(o){const t=Object(w.generate)();return i.error({msg:"Could not cancel session",errorId:t,err:o,payload:e}),null==r||r.setAttributes({"error.id":t}),null==r||r.setStatus({code:P.CanonicalCode.INTERNAL,message:"Unexpected error while cancel session & update message"}),s.json({text:`Internal server error, please try again later (error code: ${t})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`,response_type:"ephemeral",replace_original:!1})}return process.env.COUNTLY_APP_KEY&&h.a.add_event({key:"topic_cancelled",count:1,segmentation:{}}),s.send()}))}}return fe([N()],e,"interactiveMessage",null),fe([N()],e,"viewSubmission",null),fe([N()],e,"createSession",null),fe([N()],e,"vote",null),fe([N()],e,"revealSession",null),fe([N()],e,"cancelSession",null),e})();var he=function(e,t,n,s){return new(n||(n=Promise))((function(r,o){function i(e){try{c(s.next(e))}catch(e){o(e)}}function a(e){try{c(s.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}c((s=s.apply(e,t||[])).next())}))};n(23).config(),function(){he(this,void 0,void 0,(function*(){const e=new s.BasicTracerProvider;if(e.register(),!process.env.REPORT_TRACES)return;const t=new r.JaegerExporter({serviceName:"pp",tags:[],host:process.env.JAEGER_HOST,port:parseInt(process.env.JAEGER_PORT,10),logger:{debug:()=>{},info:()=>{},warn:i.warn.bind(i),error:i.error.bind(i)}});e.addSpanProcessor(new s.BatchSpanProcessor(t)),i.info({msg:"Trace reporter started",jaegerAgent:{host:process.env.JAEGER_HOST,port:process.env.JAEGER_PORT}})}))}(),function(){return he(this,void 0,void 0,(function*(){yield function(){return l(this,void 0,void 0,(function*(){return d?(i.warn({msg:"Trying to init sqlite multiple times!"}),d):(i.info({msg:"Opening sqlite..."}),d=yield Object(c.open)({filename:process.env.DB_FILE,driver:a.Database}),i.info({msg:"Migrating sqlite..."}),yield d.migrate(),d)}))}(),process.env.USE_REDIS&&(yield function(){return m(this,void 0,void 0,(function*(){return f?(i.warn({msg:"Trying to init redis multiple times!"}),f):(i.info({msg:"Creating redis client..."}),f=p.createClient(),yield new Promise((e,t)=>{f.once("ready",e),f.once("error",t)}),f.on("error",e=>{i.error({msg:"Unexpected redis error",err:e})}),f)}))}()),yield function(){return he(this,void 0,void 0,(function*(){const e=y();return e.engine("html",I({extname:".html"})),e.set("view engine","html"),e.set("views","src/views"),e.use(g.urlencoded({extended:!1})),e.use(g.json()),e.use(process.env.BASE_PATH,y.static("src/public")),function(e){const t=y.Router();t.get("/",(e,t,n)=>{t.render("index",{layout:!1,data:{SLACK_CLIENT_ID:process.env.SLACK_CLIENT_ID,SLACK_SCOPE:process.env.SLACK_SCOPE,SLACK_APP_ID:process.env.SLACK_APP_ID,COUNTLY_URL:process.env.COUNTLY_URL,COUNTLY_APP_KEY:process.env.COUNTLY_APP_KEY}})}),t.get("/privacy",(e,t,n)=>{t.render("privacy",{layout:!1,data:{SLACK_APP_ID:process.env.SLACK_APP_ID,COUNTLY_URL:process.env.COUNTLY_URL,COUNTLY_APP_KEY:process.env.COUNTLY_APP_KEY}})}),t.get("/oauth",$.handle),t.post("/slack/pp-command",ae.handle),t.post("/slack/pp-slash-command",ae.handle),t.post("/slack/action-endpoint",_e.handle),t.post("/slack/interactivity",_e.handle),t.get("/slack/direct-install",(e,t,n)=>{const s=`https://slack.com/oauth/v2/authorize?client_id=${process.env.SLACK_CLIENT_ID}&scope=${process.env.SLACK_SCOPE}`;t.status(302).redirect(s)}),e.use(""+process.env.BASE_PATH,t)}(e),new Promise((t,n)=>{e.listen(process.env.PORT,e=>{if(e)return n(e);i.info({msg:"Server running",port:process.env.PORT}),t()})})}))}(),process.env.COUNTLY_APP_KEY&&process.env.COUNTLY_URL&&(i.info({msg:"Initing countly",url:process.env.COUNTLY_URL,appKey:process.env.COUNTLY_APP_KEY}),h.a.init({app_key:process.env.COUNTLY_APP_KEY,url:process.env.COUNTLY_URL})),i.info({msg:"Boot successful!"})}))}().catch(e=>{i.error({msg:"Could not boot",err:e}),process.exit(1)})}]);
//# sourceMappingURL=app.js.map